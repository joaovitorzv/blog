<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta property="og:url" content="https://joaovitorzv.github.io"/><meta property="og:type" content="website"/><meta property="og:locale" content="pt_BR"/><meta property="og:site_name" content="@joaovitorzv • blog"/><title>Recovering a Cloud Formation Stack from UPDATE_ROLLBACK_FAILED state</title><meta name="description" content="My experience recovering a Cloud Formation Stack from a bad state I got into"/><meta name="next-head-count" content="10"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css"/><link rel="icon" href="/assets/blog-icon.ico"/><meta name="google-site-verification" content="BXyBgJEABD-lS0WS6u07BLfhlhHI8sT9TtYOH-VtkYs"/><meta name="google-site-verification" content="v91Ks9t_Nh0XGmwV8GKa5bH-96U4ZKw23VpZajlhi6Y"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/6052dd519fe31eb0.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/6052dd519fe31eb0.css" crossorigin="" data-n-g=""/><link rel="preload" href="/_next/static/css/557c1bb88c2302ce.css" as="style" crossorigin=""/><link rel="stylesheet" href="/_next/static/css/557c1bb88c2302ce.css" crossorigin="" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/main-d2ba44903cd47711.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/_app-6ea97574f4b96297.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/664-bd157c0c144b8096.js" defer="" crossorigin=""></script><script src="/_next/static/chunks/pages/z/%5Bslug%5D-33c6fa549c59e3c8.js" defer="" crossorigin=""></script><script src="/_next/static/i6EhMcV1f_kE8IGz4FWgg/_buildManifest.js" defer="" crossorigin=""></script><script src="/_next/static/i6EhMcV1f_kE8IGz4FWgg/_ssgManifest.js" defer="" crossorigin=""></script><style data-href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro&Zen+Antique+Soft&family=IBM+Plex+Mono:wght@400;600&display=swap">@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n5is.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6qfjptAgt5VM-kVkqdyU8n3vAO8lQ.woff) format('woff')}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeaiXA.woff) format('woff')}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iIq131nj-otFQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1isq131nj-otFQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iAq131nj-otFQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1iEq131nj-otFQ.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F63fjptAgt5VM-kVkqdyU8n1i8q131nj-o.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6qfjptAgt5VM-kVkqdyU8n3vAOwl1FgsAXHNlYzg.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6qfjptAgt5VM-kVkqdyU8n3vAOwlRFgsAXHNlYzg.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6qfjptAgt5VM-kVkqdyU8n3vAOwl9FgsAXHNlYzg.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6qfjptAgt5VM-kVkqdyU8n3vAOwl5FgsAXHNlYzg.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'IBM Plex Mono';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v19/-F6qfjptAgt5VM-kVkqdyU8n3vAOwlBFgsAXHNk.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeauXk-oAGIyY0Wfw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeauXA-oAGIyY0Wfw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeauXc-oAGIyY0Wfw.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeauXs-oAGIyY0Wfw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeauXo-oAGIyY0Wfw.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Source Serif Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourceserifpro/v17/neIQzD-0qpwxpaWvjeD0X88SAOeauXQ-oAGIyY0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><header class="Header_header__z1DZP"><div class="Header_headerContent__wsTR0"><h1><span class="Header_hideLinksBtn__1ASw3">@joaovitorzv</span> blog.</h1></div><nav id="navigation" class=""><div class="Header_navContent__EFrNL"><div class="Header_horizontal__njMrX"><div class="Header_links__7__VU"><a href="/">Home</a></div><div class="Header_links__7__VU"><a href="/about">About</a></div></div><div class="Header_links__7__VU"><a class="Header_link__OJ7mG" href="https://www.github.com/joaovitorzv" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="#ffff"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a><a class="Header_link__OJ7mG" href="https://www.linkedin.com/in/jo%C3%A3o-vitor-veras-165045186/" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="#ffff"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></div></div></nav></header><div class="wrapper __variable_24d6f1" style="max-width:var(--reading-width);margin:0 auto;font-family:var(--font-ovo);font-size:20px;line-height:1.2"><h1 style="font-size:28px;color:white;font-weight:900">How to recover a Cloud Formation Stack from UPDATE_ROLLBACK_FAILED state</h1>
<p>Recently I was working on a feature where I needed a lambda function with a custom concurrency limit.</p>
<p>I thought I could just add the <code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:2px 6px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal">&quot;ReservedConcurrentExecutions&quot;</code> property to the Cloud Formation Template run the Amplify CLI
deploy and call it a day, but... things didn’t go as expected and I got some errors:</p>
<pre><code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:12px 12px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal" class="hljs language-shell">LambdaFunction       AWS::Lambda::Function       UPDATE_FAILED        Wed Oct 02 2024 17:40:03…

🛑 The following resources failed to deploy:
Resource Name: LambdaFunction (AWS::Lambda::Function)
Event Type: update
Reason: Resource handler returned message: &quot;User: arn:aws:sts::***:assumed-role/us-east-1_***/amplifyadmin is not authorized to perform: lambda:PutFunctionConcurrency on resource: arn:aws:lambda:us-east-1:***:function:***-staging because no identity-based policy allows the lambda:PutFunctionConcurrency action (Service: Lambda, Status Code: 403, Request ID: ***)&quot; (RequestToken: ***, HandlerErrorCode: AccessDenied)
URL: *redacted*

Resource Name: LambdaFunction (AWS::Lambda::Function)
Event Type: update
Reason: Resource handler returned message: &quot;User: arn:aws:sts::***:assumed-role/us-east-1_***/amplifyadmin is not authorized to perform: lambda:DeleteFunctionConcurrency on resource: arn:aws:lambda:us-east-1:***:function:***-staging because no identity-based policy allows the lambda:DeleteFunctionConcurrency action (Service: Lambda, Status Code: 403, Request ID: ***)&quot; (RequestToken: ***, HandlerErrorCode: AccessDenied)
URL: *redacted*

🛑 Resource is not in the state stackUpdateComplete
</code></pre>
<p>two errors happened, first it failed to execute the <code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:2px 6px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal">PutFunctionConcurrency</code> because the <code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:2px 6px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal">amplifyadmin</code> role used by Amplify CLI
does not have this policy by default and I was not aware of it</p>
<p>then it tried to rollback and for some reason executed <code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:2px 6px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal">DeleteFunctionConcurrency</code> even though it failed to update it in the first
place, this got the Cloud Formation Stack in the <code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:2px 6px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal">UPDATE_ROLLBACK_FAILED</code> state where nothing could be done through the CLI
anymore, things must be fixed manually through AWS Console.</p>
<h1 style="font-size:28px;color:white;font-weight:900">How I got it fixed</h1>
<p>the &quot;manual&quot; fix in this case was simple, I went to the IAM Console searched for the amplifyadmin role and asssigned the missing
policies to it</p>
<pre><code style="font-size:13px;background-color:#1c1c1c;color:#a7d8fc;border-radius:7px;padding:12px 12px;border:1px solid #2e2e2e;font-family:monospace;font-weight:normal" class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;Version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2012-10-17&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;Statement&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;Sid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;VisualEditor0&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Effect&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Allow&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Action&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">&quot;lambda:DeleteFunctionConcurrency&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">&quot;lambda:PutFunctionConcurrency&quot;</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;Resource&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;*&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>and then I had to re-trigger the rollback of the stack, to get this done I went to the Cloud Formation Console selected the stack
failling with UPDATE_ROLLBACK_FAILED, on the “Stack Actions” menu is listed the option “Continue Update Rollback” which is
what we want</p>
<p><img style="width:auto;max-width:100%;height:auto;border-radius:7px;cursor:pointer" src="/assets/cfn-stack-menu.png" alt="CloudFormation Stack Actions Menu"/></p>
<p>the &quot;Continue Update Rollback&quot; give us the option to skip the update of failing nested stacks (this means I could skip the failed lambda
stack that caused this problem) it also displays a super scary message that states if we skip the rollback of a nested stack and don&#x27;t
fix it to be in sync with the parent stack later our whole stack might become unrecoverable.</p>
<p><img style="width:auto;max-width:100%;height:auto;border-radius:7px;cursor:pointer" src="/assets/cfn-skip-warn.png" alt="CloudFormation skip stack warning"/></p>
<p>happily we already know what caused the issue and fixed it by assigning the policies to the CLI IAM role, we can now re-trigger the rollback without skipping the nested stack.</p>
<p>at this point the stack was successfully rolled back and I could use the Amplify CLI to deploy the changes again.</p>
<p>a fun thing to note is that after losing some time on that I actually ended up implementing a pessimist-locking solution for the feature
I was working instead of using a custom lambda concurrency, but still learned a lot.</p></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"source":{"compiledSource":"\"use strict\";\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = {\n    code: \"code\",\n    h1: \"h1\",\n    img: \"img\",\n    p: \"p\",\n    pre: \"pre\",\n    span: \"span\",\n    ..._provideComponents(),\n    ...props.components\n  };\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"How to recover a Cloud Formation Stack from UPDATE_ROLLBACK_FAILED state\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Recently I was working on a feature where I needed a lambda function with a custom concurrency limit.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"I thought I could just add the \", _jsx(_components.code, {\n        children: \"\\\"ReservedConcurrentExecutions\\\"\"\n      }), \" property to the Cloud Formation Template run the Amplify CLI\\ndeploy and call it a day, but... things didn’t go as expected and I got some errors:\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"hljs language-shell\",\n        children: \"LambdaFunction       AWS::Lambda::Function       UPDATE_FAILED        Wed Oct 02 2024 17:40:03…\\n\\n🛑 The following resources failed to deploy:\\nResource Name: LambdaFunction (AWS::Lambda::Function)\\nEvent Type: update\\nReason: Resource handler returned message: \\\"User: arn:aws:sts::***:assumed-role/us-east-1_***/amplifyadmin is not authorized to perform: lambda:PutFunctionConcurrency on resource: arn:aws:lambda:us-east-1:***:function:***-staging because no identity-based policy allows the lambda:PutFunctionConcurrency action (Service: Lambda, Status Code: 403, Request ID: ***)\\\" (RequestToken: ***, HandlerErrorCode: AccessDenied)\\nURL: *redacted*\\n\\nResource Name: LambdaFunction (AWS::Lambda::Function)\\nEvent Type: update\\nReason: Resource handler returned message: \\\"User: arn:aws:sts::***:assumed-role/us-east-1_***/amplifyadmin is not authorized to perform: lambda:DeleteFunctionConcurrency on resource: arn:aws:lambda:us-east-1:***:function:***-staging because no identity-based policy allows the lambda:DeleteFunctionConcurrency action (Service: Lambda, Status Code: 403, Request ID: ***)\\\" (RequestToken: ***, HandlerErrorCode: AccessDenied)\\nURL: *redacted*\\n\\n🛑 Resource is not in the state stackUpdateComplete\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"two errors happened, first it failed to execute the \", _jsx(_components.code, {\n        children: \"PutFunctionConcurrency\"\n      }), \" because the \", _jsx(_components.code, {\n        children: \"amplifyadmin\"\n      }), \" role used by Amplify CLI\\ndoes not have this policy by default and I was not aware of it\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"then it tried to rollback and for some reason executed \", _jsx(_components.code, {\n        children: \"DeleteFunctionConcurrency\"\n      }), \" even though it failed to update it in the first\\nplace, this got the Cloud Formation Stack in the \", _jsx(_components.code, {\n        children: \"UPDATE_ROLLBACK_FAILED\"\n      }), \" state where nothing could be done through the CLI\\nanymore, things must be fixed manually through AWS Console.\"]\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"How I got it fixed\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"the \\\"manual\\\" fix in this case was simple, I went to the IAM Console searched for the amplifyadmin role and asssigned the missing\\npolicies to it\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-json\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"{\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"\\\"Version\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"2012-10-17\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \",\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"\\\"Statement\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"[\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"{\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"\\\"Sid\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"VisualEditor0\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \",\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"\\\"Effect\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"Allow\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \",\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"\\\"Action\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"[\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"lambda:DeleteFunctionConcurrency\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \",\"\n        }), \"\\n        \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"lambda:PutFunctionConcurrency\\\"\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"]\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \",\"\n        }), \"\\n      \", _jsx(_components.span, {\n          className: \"hljs-attr\",\n          children: \"\\\"Resource\\\"\"\n        }), _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \":\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"*\\\"\"\n        }), \"\\n    \", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"}\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"]\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"hljs-punctuation\",\n          children: \"}\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"and then I had to re-trigger the rollback of the stack, to get this done I went to the Cloud Formation Console selected the stack\\nfailling with UPDATE_ROLLBACK_FAILED, on the “Stack Actions” menu is listed the option “Continue Update Rollback” which is\\nwhat we want\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"/assets/cfn-stack-menu.png\",\n        alt: \"CloudFormation Stack Actions Menu\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"the \\\"Continue Update Rollback\\\" give us the option to skip the update of failing nested stacks (this means I could skip the failed lambda\\nstack that caused this problem) it also displays a super scary message that states if we skip the rollback of a nested stack and don't\\nfix it to be in sync with the parent stack later our whole stack might become unrecoverable.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"/assets/cfn-skip-warn.png\",\n        alt: \"CloudFormation skip stack warning\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"happily we already know what caused the issue and fixed it by assigning the policies to the CLI IAM role, we can now re-trigger the rollback without skipping the nested stack.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"at this point the stack was successfully rolled back and I could use the Amplify CLI to deploy the changes again.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"a fun thing to note is that after losing some time on that I actually ended up implementing a pessimist-locking solution for the feature\\nI was working instead of using a custom lambda concurrency, but still learned a lot.\"\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = {\n    ..._provideComponents(),\n    ...props.components\n  };\n  return MDXLayout ? _jsx(MDXLayout, {\n    ...props,\n    children: _jsx(_createMdxContent, {\n      ...props\n    })\n  }) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"meta":{"id":4,"title":"Recovering a Cloud Formation Stack from UPDATE_ROLLBACK_FAILED state","description":"My experience recovering a Cloud Formation Stack from a bad state I got into","date":"10-02-2024","language":"en"}},"__N_SSG":true},"page":"/z/[slug]","query":{"slug":"cloud-formation-update-rollback-failed"},"buildId":"i6EhMcV1f_kE8IGz4FWgg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>